<?php

/**
 * @file
 * Contains pbc_automation.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Datetime\DrupalDateTime;

/**
 * Implements hook_help().
 */
function pbc_automation_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the pbc_automation module.
    case 'help.page.pbc_automation':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Handles various tasks that need to happen nightly and throughout the week. Mostly a hook_cron implementation.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_cron().
 */
function pbc_automation_cron() {
  $utility = Drupal::service('pbc_groups.utility');
  $storage = Drupal::getContainer()->get('entity_type.manager')->getStorage('node');

  // Get the start date for the week (Sunday).
  $start = new DrupalDateTime();
  // If the given date is Sunday, use it as the start date.
  if ($start->format('w') == 0) {
    $startDate = $start->format('Y-m-d');
  }
  else {
    $start->modify('last sunday');
    $startDate = $start->format('Y-m-d');
  }

  // Get the end date for the week (Saturday).
  $end = new DrupalDateTime();
  // If the given date is Saturday, use it as the end date.
  if ($end->format('w') == 6) {
    $endDate = $end->format('Y-m-d');
  }
  else {
    $end->modify('next saturday');
    $endDate = $end->format('Y-m-d');
  }

  // Load all the published & active groups.
  $groups = $storage->loadByProperties([
    'type' => 'group',
    'status' => 1,
    'field_group_status' => 'Active',
  ]);

  foreach ($groups as $group) {
    // See if a record already exists for this week.
    $attendance = $storage->getQuery()->count()
      ->condition('type', 'group_attendance_record')
      ->condition('status', 1)
      ->condition('field_group', $group->id())
      ->condition('field_meeting_date', [$startDate, $endDate], 'BETWEEN')
      ->accessCheck(FALSE)
      ->execute();

    if ($attendance == 0) {
      // Attendance not created for the current week.
      // Check if we should create it based on the meeting day and time.
      $day = $group->field_meeting_day->getString();
      $days = [
        'Sunday' => '12:00',
        'Monday' => '18:00',
        'Tuesday' => '18:00',
        'Wednesday' => '18:00',
        'Thursday' => '18:00',
        'Friday' => '18:00',
        'Saturday' => '12:00',
      ];

      // Find the meeting date within the current week.
      $dayMap = [
        'Sunday' => 0,
        'Monday' => 1,
        'Tuesday' => 2,
        'Wednesday' => 3,
        'Thursday' => 4,
        'Friday' => 5,
        'Saturday' => 6,
      ];
      $meetingDateObj = new DrupalDateTime($startDate);
      $daysUntilMeeting = ($dayMap[$day] - $meetingDateObj->format('w')) % 7;
      $meetingDateObj->modify('+' . $daysUntilMeeting . ' days');
      $meetingDate = $meetingDateObj->format('Y-m-d');
      $meetingTime = $days[$day];

      // Get current date and time.
      $now = new DrupalDateTime();
      $nowDate = $now->format('Y-m-d');
      $nowTime = $now->format('H:i');

      // Create attendance if we've reached or passed the meeting day and time.
      if ($nowDate > $meetingDate || ($nowDate == $meetingDate && $nowTime >= $meetingTime)) {
        $groupAttendValues = [
          'type' => 'group_attendance_record',
          'field_group' => $group->id(),
          'field_meeting_date' => $meetingDate,
        ];

        // Create group_attendance_record node.
        if ($attendance = $utility->createNode($groupAttendValues)) {
          // Send attendance manager an email.
          $user = $attendance->field_group->entity->field_attendance_manager->entity;
          $emails = [$user->getEmail()];
          // Notify additional folks if need be.
          if ($user->hasField('field_also_notify') && !$user->field_also_notify->isEmpty()) {
            $additional_emails = array_column($user->get('field_also_notify')->getValue(), 'value');
            $emails = array_merge($emails, $additional_emails);
          }

          // Use Symfony Mailer
          $emailFactory = \Drupal::service('email_factory');
          $email = $emailFactory->newTypedEmail('pbc_automation', 'attendance_reminder', $user, $attendance);
          $email->setTo($emails);

          $mailer = \Drupal::service('symfony_mailer');
          $mailer->send($email);
        }
      }
    }
  }
}

/**
 * Implements hook_theme().
 */
function pbc_automation_theme($existing, $type, $theme, $path) {
  return [
    'symfony_mailer__pbc_automation__attendance_reminder' => [
      'variables' => [
        'email' => NULL,
        'user_name' => NULL,
        'login_url' => NULL,
      ],
      'template' => 'attendance-reminder',
    ],
  ];
}
